## **一、Socket套接字的作用**  
- **定义**：C#中用于网络通信的类（`System.Net.Sockets`命名空间），其他语言（如C++、Java）也有类似类，底层遵循TCP/IP协议。  
- **核心作用**：支持TCP/IP网络通信的基本操作单位，作为客户端与服务端之间的“数据通道”（类比“管子”），用于连接两端并收发消息（尤其适用于长连接游戏）。  
- **关键信息**：一个Socket对象包含：本机IP+端口、对方主机IP+端口、双方通信协议信息。  

---

## **二、Socket的类型**  
Socket主要分为三类（重点掌握前两类）：  

| 类型             | 用途                 | 特点                                                      |
| ---------------- | -------------------- | --------------------------------------------------------- |
| **流套接字**     | TCP通信              | 面向连接、可靠、有序；数据无差错、无重复；基于字节流。    |
| **数据报套接字** | UDP通信              | 无连接；数据包≤32KB；不保证可靠性、顺序；可能丢包/重复。  |
| **原始套接字**   | IP数据包通信（了解） | 直接访问协议底层；用于侦听/分析数据包（如网络安全场景）。 |

**声明Socket的构造函数**：
```C#
public Socket(SocketInformation socketInformation);
public Socket(SocketType socketType, ProtocolType protocolType);
public Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType); // 常用 
```  
1. **网络寻址方案**（`AddressFamily`枚举）：常用`InterNetwork`（IPv4寻址方案）、`InterNetworkV6`（IPv6寻址方案）。  
2. **套接字类型**（`SocketType`枚举）：  
   - `Dgram`：数据报类型（对应UDP）；  
   - `Stream`：流类型（对应TCP）。  
3. **协议类型**（`ProtocolType`枚举）：常用`Tcp`（TCP协议）、`Udp`（UDP协议）。  

**常用声明示例**：  
```csharp
// TCP套接字（流套接字）
Socket socketTcp = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
// UDP套接字（数据报套接字）
Socket socketUdp = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);
// Internet控制报文协议
Socket socketIcmp = new Socket(AddressFamily.InterNetwork, SocketType.Raw, ProtocolType.Icmp);
// 简单IP包通信
Socket socketIp = new Socket(AddressFamily.InterNetwork, SocketType.Raw, ProtocolType.Raw);
```

---

## **三、Socket的常用属性（基础）**  
后续开发中频繁使用，当前仅需建立概念：  
1. **连接状态**（`Connected`）：布尔值，判断当前是否处于连接状态。  
2. **套接字类型**（`SocketType`）：返回声明时的类型（如`Stream`或`Dgram`）。  
3. **协议类型**（`ProtocolType`）：返回声明时的协议（如`Tcp`或`Udp`）。  
4. **寻址方案**（`AddressFamily`）：返回声明时的寻址类型（如`InterNetwork`）。  
5. **可读取数据量**（`Available`）：返回网络中待读取的字节数（int）。  
6. **本机端点**（`LocalEndPoint`）：返回本机的`IPEndPoint`（需转换为`IPEndPoint`获取IP和端口）。  
7. **远程端点**（`RemoteEndPoint`）：返回已连接远端的`IPEndPoint`（需转换为`IPEndPoint`）。  

---

## **四、Socket的常用方法**  
按使用场景分为服务端、客户端、通用方法（基础）：  

##### **1. 服务端专用方法（暂时只讲解同步方法）**  
- **绑定IP和端口**（`Bind`）：将Socket与指定IP和端口绑定（如`IPEndPoint`对象）。  
  ```csharp
  IPEndPoint ipEndPoint = new IPEndPoint(IPAddress.Parse("127.0.0.1"), 8080);
  socketTcp.Bind(ipEndPoint); // 绑定本机127.0.0.1:8080
  ```  
- **设置最大连接数**（`Listen`）：限制服务端最多同时连接的客户端数（如`Listen(10)`表示最多10个连接）。  
- **等待客户端接入**（`Accept`）：阻塞等待客户端连接，返回与该客户端通信的Socket对象。  

##### **2. 客户端专用方法**  
- **连接远端服务器**（`Connect`）：客户端主动连接服务端（需传入服务端IP和端口或`IPEndPoint`）。  
  ```csharp
  socketTcp.Connect(IPAddress.Parse("118.111.123.111"), 8080); // 连接远端服务器
  ```  

##### **3. 通用方法（服务端/客户端均需）**  
- **发送数据**：  
  - TCP：`Send(byte[] data)`（同步）；另有异步版本（如`BeginSend`）。  
  - UDP：`SendTo(byte[] data, IPEndPoint remoteEP)`（同步）；另有异步版本。  
- **接收数据**：  
  - `Receive(byte[] buffer)`（同步接收数据到字节数组）；另有异步版本（如`BeginReceive`）。  
- **释放和关闭连接**：  
  - `Shutdown(SocketShutdown mode)`：停止发送/接收（如`SocketShutdown.Both`停止双向通信，先于`Close`调用）。  
  - `Close()`：释放资源，彻底关闭Socket。  

---

## **五、Socket套接字TCP通信概述**


#### **一、本节课核心目标**  
讲解TCP通信的服务端与客户端编程流程，以及TCP三次握手、四次挥手在Socket编程中的体现。  

---

#### **二、服务端与客户端的编程流程（核心图示）**  

##### **1. 服务端编程步骤**  
1. **创建套接字**：实例化Socket对象（如`new Socket(...)`）。  
2. **绑定地址**：通过`Bind`方法将Socket与本机IP和端口绑定（需`IPEndPoint`对象）。  
3. **监听连接**：通过`Listen`方法设置最大客户端连接数（如`Listen(10)`限制最多10个连接）。  
4. **接受连接**：通过`Accept`方法阻塞等待客户端连接，返回与该客户端通信的新Socket对象。  
5. **收发数据**：使用新Socket对象的`Send`（发送）和`Receive`（接收）方法与客户端通信。  
6. **关闭连接**：通信完成后，调用`Shutdown`释放连接（停止收发），再调用`Close`彻底关闭Socket。  

##### **2. 客户端编程步骤**  
1. **创建套接字**：实例化Socket对象（与服务端类型一致，如TCP用`Stream`类型）。  
2. **连接服务端**：通过`Connect`方法连接服务端（需传入服务端IP和端口或`IPEndPoint`）。  
3. **收发数据**：使用`Send`和`Receive`方法与服务端通信（同服务端第5步）。  
4. **关闭连接**：通信完成后，调用`Shutdown`释放连接，再调用`Close`彻底关闭Socket。  

**关键提示**：流程需牢记，下节课将基于此逐步实现代码。  

---

#### **三、TCP三次握手在Socket编程中的体现**  
- **背景**：TCP建立连接需三次握手（底层协议机制）。  
- **Socket中的体现**：  
  1. 客户端调用`Connect`方法发起连接（第一次握手）。  
  2. 服务端`Accept`方法阻塞等待，收到连接请求后返回响应（第二次握手）。  
  3. 客户端`Connect`方法执行完毕（阻塞解除），确认连接建立（第三次握手）。  
- **结论**：三次握手被Socket底层封装，`Connect`和`Accept`方法自动完成，无需手动处理。  

---

#### **四、TCP四次挥手在Socket编程中的体现**  
- **背景**：TCP断开连接需四次挥手（底层协议机制）。  
- **Socket中的体现**：  
  1. 客户端/服务端调用`Close`方法发起关闭请求（第一次挥手）。  
  2. 对方收到请求后回复确认（第二次挥手，Socket自动处理）。  
  3. 主动关闭方发送剩余数据并通知对方“数据发送完毕”（第三次挥手）。  
  4. 对方确认后完成关闭（第四次挥手，Socket自动处理）。  
- **结论**：四次挥手被Socket底层封装，`Shutdown`和`Close`方法自动完成，无需手动处理。  

---